### **Description**

This Cornerstone theme modification introduces recommendations flow to UX.
Below you could find description of consecutive steps happening in browser during the period user lands on product page
and see products in "Related products" section.

### **Theme modifications**

JavaScript code for running recommendations flow resides in `/assets/js/theme/product/recommendations` folder.
In order execute recommendations flow `applyRecommendations()` method from `recommendations.js` is invoked.

Changes made to the theme files except `/assets/js/theme/product/recommendations` folder:
1. Overlay block added to `/templates/components/products/tabs.html` in order to show spinner while
recommendations are being loaded.
Also, "recommendations" class added to "Related products" tab element and css is slightly overridden
for it in `/assets/scss/recommendations.scss`.

2. Data attributes (`data-token-url="add-to-cart"` or `data-token-url="product-detail-page"`)
are added to anchor elements in `templates/components/products/card.html`
in order to be able to select elements in runtime and add static/recommendation token to urls.
This is used by backend to recognize requests and calculate click-through rate during recommendation and default flows.

3. Some data is injected inside `templates/pages/product.html` in order to be accessible in js context
inside `/assets/js/theme/product.js`.

4. `/assets/js/theme/product.js` is tweaked to invoke recommendations flow inside `onReady()` method.

### **Algorithm**

1. User goes to product detail view and browser sends request for a product page.
`/templates/pages/product.html` is rendered server-side with some related products markup inside.
In addition, with the response visitor group cookie `bc_rec_ab` is sent.

2. Entry point of recommendations flow: `/assets/js/theme/product.js: 59`.
Cookie value with key`bc_rec_ab` is read.

    2a. If the value corresponds to "Control group" (0) then "static token" assigned to
        all "Add To Cart" or "Detailed Product View" links inside each related product card.
        The flow is finished.
        `/assets/js/theme/product/recommendations/recommendations.js: 159`

    2b. If the value is equal to "Treatment Group" (1) then execution proceeds to next step.
        `/assets/js/theme/product/recommendations/recommendations.js: 116`

3. Spinner is laid over currently rendered related products.
`/assets/js/theme/product/recommendations/recommendations.js: 124`

4. Http request to cloud function is made (`/assets/js/theme/product/recommendations/recommendations.js: 23`).
Response should contain recommendation token along with product ids generated by Recommendation AI.
Host of the cloud function is located at `/assets/js/theme/product/recommendations/constants.js`.
        
        Please, modify `CLOUD_FUNCTION_URL` constant to match an url of your deployed cloud function instance.
        Then the theme should be rebuilt by Stencil and uploaded to the store.
        Also, please, don't forget to setup `Access-Control-Allow-Headers` header which allows your frontend's
        domain make cross-origin HTTP requests to cloud function.

5. If request is successful and product ids are received,
another GraphQL request is made to the backend in order to get product details (name, image, price, etc.).
`/assets/js/theme/product/recommendations/recommendations.js: 58`

6. If GraphQL request is successful, markup for product cards elements is generated applying received data.
Recommendation token (from p. 4) is attached to "Add To Cart" or "Detailed Product View" links
in each generated product card.
Finally, elements are inserted to DOM.
`/assets/js/theme/product/recommendations/recommendations-carousel.js: 94`

7. Spinner is hidden and newly generated recommended products are shown.
In case of error at steps 4-6, spinner is hidden and initial related products are shown.
